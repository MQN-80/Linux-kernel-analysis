# 中断机制
中断机制是计算机发展中的一种重要技术，是指在CPU正常运行期间，由于内外部事件或由程序预先安排的事件引起的CPU暂时停止正在运行的程序，转而为该内部或外部事件或预先安排的事件服务的程序中去，服务完毕后再返回去继续运行被暂时中断的程序。
# 1.中断基本知识
## 1.1中断向量
> `Intel x86`系列微机共支持 256 种向量中断，为使处理器较容易地识别每种中断源，将它们从 0～256 编号，即赋予一个中断类型码 n，Intel 把这个 8 位的无符号整数叫做一个向量，因此，也叫`中断向量`  
所有 256 种中断可分为两大类：异常和中断。异常又分为`故障`(Fault)和`陷阱`(Trap),它们的共同特点是既不使用中断控制器，又不能被屏蔽。中断又分为外部可屏蔽中断（INTR）和外部非屏蔽中断（NMI），所有 I/O 设备产生的中断请求（IRQ）均引起屏蔽中断，而紧急的事件（如硬件故障）引起的故障产生非屏蔽中断

Linux对256个向量的分配如下:
* 0-31的向量对应异常和非屏蔽中断
* 32-47的向量(即由I/O设备引起的中断)分配给屏蔽中断
* 剩余的48-255的向量用来标识软中断,Linux只用了一个来实现系统调用，即`0x80`，当用户态的进程执行一条`int 0x80`的汇编指令时，CPU就切换到内核态，并开始执行`system_call()`内核函数
## 1.2 外设可屏蔽中断
> `Intel x86`通过两片中断控制器`8259A`来响应 15 个外中断源，每个 8259A 可管理 8 个中断源。第 1 级（称主片）的第 2 个中断请求输入端，与第 2 级 8259A（称从片）的中断输出端 INT 相连,我们把与中断控制器相连的每条线叫做中断线，要使用中断线，就得进行中断线的申请，就是`IRQ`(Interrupt ReQuirement)，我们也常把申请一条中断线称为申请一个 IRQ 或者是申请一个中断号。IRQ 线是从 0 开始顺序编号的，因此，第一条 IRQ线通常表示成 IRQ0。IRQn 的缺省向量是 n+32；如前所述，IRQ 和向量之间的映射可以通过中断控制器端口来修改，中断结构如下所示
![8259A](./images/1.png)
中断控制器 8259A 执行如下操作。  
1. 监视中断线，检查产生的中断请求（IRQ）信号。 
2. 如果在中断线上产生了一个中断请求信号。   
a. 把接受到的 IRQ 信号转换成一个对应的向量。   
b. 把这个向量存放在中断控制器的一个 I/O 端口，从而允许 CPU 通过数据总线读此向量。   
c. 把产生的信号发送到 CPU 的 INTR 引脚——即发出一个中断。   
d. 等待，直到 CPU 确认这个中断信号，然后把它写进可编程中断控制器（PIC）的一个 I/O 端口；此时，清 INTR 线。  
3. 返回到第一步。   
* 对于外部 I/O 请求的屏蔽可分为两种情况，一种是从 CPU 的角度，也就是清除 eflag 的
中断标志位（IF），当 IF=0 时，禁止任何外部 I／O 的中断请求，即关中断；一种是从中断控
制器的角度，因为中断控制器中有一个 8 位的中断屏蔽寄存器（IMR），每位对应 8259A 中的
一条中断线，如果要禁用某条中断线，则把 IRM 相应的位置 1，要启用，则置 0。
## 异常和非屏蔽中断
> `异常`就是 CPU 内部出现的中断，也就是说，在 CPU 执行特定指令时出现的非法情况。`非屏蔽中断`就是计算机内部硬件出错时引起的异常情况

在 CPU 执行一个异常处理程序时，就不再为其他异常或可屏蔽中断请求服务，也就是说，当某个异常被响应后，CPU 清除 eflag 的中 IF 位，禁止任何可屏蔽中断。但如果又有异常产生，则由 CPU 锁存(CPU 具有缓冲异常的能力)  
Intel x86 处理器发布了大约 20 种异常（具体数字与处理器模式有关）。Linux 内核必
须为每种异常提供一个专门的异常处理程序。这里特别说明的是，在某些异常处理程序开始
执行之前，CPU 控制单元会产生一个硬件错误码，内核先把这个错误码压入内核栈中。
|向量|异常名